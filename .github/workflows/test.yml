name: Run SWFRecomp Tests

on:
  # Manual trigger only
  workflow_dispatch:
    inputs:
      max_tests:
        description: 'Maximum number of tests to run (leave empty for all)'
        required: false
        default: '1'
        type: string
      clean:
        description: 'Clean build before running tests'
        required: false
        default: false
        type: boolean

permissions:
  contents: write  # Allow pushing commits and creating branches

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake

      - name: Create or switch to test-results-update branch
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Fetch all branches
          git fetch origin

          # Check if branch exists remotely
          if git ls-remote --exit-code --heads origin test-results-update; then
            echo "Branch test-results-update exists, syncing with master"
            git checkout test-results-update
            git pull origin test-results-update

            # Make test-results-update's content match master exactly while preserving history
            echo "Syncing test-results-update to match master exactly..."

            # Remove all tracked files
            git rm -rf .

            # Restore all files from master
            git checkout origin/master -- .

            # Commit the sync if there are changes
            if ! git diff --staged --quiet; then
              git commit -m "Sync test-results-update with master before updating test results"
            else
              echo "Already in sync with master"
            fi
          else
            echo "Creating new branch test-results-update from master"
            git checkout -b test-results-update origin/master
          fi

      - name: Run tests and generate documentation
        run: |
          # Build command with optional parameters
          CMD="python3 scripts/test-and-document.py --build"

          # Add --max-tests if specified
          if [ -n "${{ github.event.inputs.max_tests }}" ]; then
            CMD="$CMD --max-tests=${{ github.event.inputs.max_tests }}"
          fi

          # Add --clean if specified
          if [ "${{ github.event.inputs.clean }}" = "true" ]; then
            CMD="$CMD --clean"
          fi

          # Run the tests and generate documentation
          echo "Running: $CMD"
          $CMD

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            SWFRecomp/tests/test_results.json
            opcode-index.json
            opcode-index.md
            opcode-index-plain.md
          retention-days: 30

      - name: Display test summary
        if: always()
        run: |
          if [ -f SWFRecomp/tests/test_results.json ]; then
            echo "## Test Results" >> $GITHUB_STEP_SUMMARY
            python3 << 'PYTHON_SCRIPT' >> $GITHUB_STEP_SUMMARY
          import json
          with open('SWFRecomp/tests/test_results.json', 'r') as f:
              data = json.load(f)
              summary = data.get('summary', {})
              print(f"**Total Tests:** {summary.get('total_tests', 0)}")
              print(f"**Passed:** {summary.get('passed', 0)}")
              print(f"**Failed:** {summary.get('failed', 0)}")
              print(f"**Sub-tests Passed:** {summary.get('passed_sub_tests', 0)}/{summary.get('total_sub_tests', 0)}")
          PYTHON_SCRIPT
          fi

      - name: Commit and push test results
        if: always()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Add the generated documentation
          git add -f opcode-index.json || true
          git add -f opcode-index.md || true
          git add -f opcode-index-plain.md || true

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            # Determine test count for commit message
            TEST_COUNT="${{ github.event.inputs.max_tests }}"
            if [ -z "$TEST_COUNT" ]; then
              TEST_COUNT="all"
            fi

            git commit -m "Update opcode documentation ($TEST_COUNT tests)" -m "Generated by workflow run: ${{ github.run_id }}" -m "Triggered by: ${{ github.actor }}" -m "Test configuration:" -m "- Max tests: $TEST_COUNT" -m "- Clean build: ${{ github.event.inputs.clean }}"

            git push origin test-results-update

            echo "âœ… Test results committed to test-results-update branch"
            echo "View the branch at: ${{ github.server_url }}/${{ github.repository }}/tree/test-results-update"
          fi
